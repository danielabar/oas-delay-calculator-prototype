<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prototype Should I Delay Old Age Security</title>

  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">
  <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">

  <!-- TailwindCSS CDN link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    integrity="sha384-HtMZLkYo+pR5/u7zCzXxMJP6QoNnQJt1qkHM0EaOPvGDIzaVZbmYr/TlvUZ/sKAg" crossorigin="anonymous">

  <!-- Chart.js CDN links (core library and chart types that you'll use) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0"
    integrity="sha384-4mFQWIqZrcfYZkFPEgIoT//zTEU64gEoH2tGV72Koyhoa9Fxz43YgroFUGj4/RAx" crossorigin="anonymous"></script>

  <!-- Chart.js Annotation plugin CDN link -->
  <!-- https://www.chartjs.org/chartjs-plugin-annotation/latest/guide/ -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.1.0"
    integrity="sha384-Vl+7jGdzaw5CRoAX/NKxRI8rP0h4gTitTx2r6kjUe9eR9zweeRReMPhAukdDzBsL" crossorigin="anonymous"></script>
</head>

<!-- TODOs: -->
<!-- Update chart annotation to also show accumulated OAS amount at break even age -->
<!-- Fix awkward wording when have full 40 years: which is 1.000 of the full amount 713.34, starting at age 65 -->
<!-- Possibly add explanation of percentage increase: This is because each month of delay increases pension amt by 0.6%... -->
<!-- Possibly add more wording after "would have to live until...", at which point you'll have accumulated {total} -->
<!-- Add section after chart titled like "What should I do" -->
<!--  Explain about life expectancy -->
<!--  Even if live to 95, it's only x% more, encourage apply with link to govt -->
<!-- Edge case: 10 years in Canada and delay to age 66, breakeven calculates as 67 but lines look like they cross over at age 80 -->
<!--  Maybe because the 2000 "good enough" needs to scale down depending on the magnitude of the difference -->
<!--  Or need to calculate data series at month rather than year level for more accuracy -->
<!--  Or change break even calc to find age with smallest diff between lines -->
<!-- Somehow communicate life expectancy wrt break even age -->
<!-- As years in Canada is lower and if they have lots of GIS, breakeven age goes off the chart (eg: 20 years in Canada, max GIS, delay to 70) -->
<!-- Name variables to be clear if they're monthly or yearly -->
<!-- Single vs plural `year` vs `years` in explanation if only delaying by 1 year -->
<!-- Make this production quality with appropriate JS framework and tests (Svelte?) -->
<!-- If there was a build system, maybe could use: https://github.com/danielabar/gis-lookup -->
<!-- Add Disclaimer section, eg wording from: https://estimateursv-oasestimator.service.canada.ca/en -->
<!-- The results are not financial advice and are subject to change. For a more accurate assessment of your estimated benefits amount, please visit https://www.canada.ca/en/employment-social-development/corporate/contact/oas.html -->

<!-- Nice to Have: -->
<!-- Print feature so user could take their results with them to someone to get more help -->

<body class="bg-gray-100 p-4">

  <div class="max-w-screen-md mx-auto">
    <div class="flex items-center mb-4">
      <img src="logo.png" alt="OAS Delay Calculator Logo" class="w-12 mr-4 rounded">
      <h1 class="text-center text-2xl font-semibold">Prototype OAS Delay Calculator</h1>
    </div>

    <div class="bg-white p-4 rounded shadow mb-6">
      <p class="text-lg leading-relaxed mb-4">
        Eligible Canadians can apply for Old Age Security (OAS) starting at age 65. It's also possible to delay
        applying up to age 70. Each month of delay will increase the benefit by 0.6%. But it may not be worth it,
        especially for low income Canadians that are also eligible for GIS. Use this calculator to determine how
        delaying could impact you.
      </p>
    </div>

    <div class="bg-white p-4 rounded shadow mb-6">
      <form id="oas-form">
        <!-- Years Lived in Canada as an Adult -->
        <div class="mb-4">
          <label for="years-in-canada" class="block text-xl font-bold mb-2">Years Lived in Canada as an Adult</label>
          <p class="text-gray-600 text-sm mb-2">(Between ages 18 and 65)</p>
          <input type="number" id="years-in-canada" name="years_in_canada"
            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            min="1" max="40" required value="40">
        </div>

        <!-- Age taking OAS: 66, 67, 68, 69, 70 -->
        <div class="mb-4">
          <label for="age-taking-oas" class="block text-xl font-bold mb-2">Delay OAS to Age</label>
          <select id="age-taking-oas" name="age_taking_oas"
            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            required>
            <option value="66">66</option>
            <option value="67">67</option>
            <option value="68">68</option>
            <option value="69">69</option>
            <option value="70" selected>70</option>
          </select>
        </div>

        <!-- Annual Income -->
        <div class="mb-4">
          <label for="income_range" class="block text-xl font-bold mb-2">Select Your Annual Income Range</label>
          <p class="text-gray-600 text-sm mb-2">(Line 23600 of your tax return, required for GIS eligibility)</p>
          <div class="flex flex-col space-y-2">
            <label class="inline-flex items-center">
              <input type="radio" name="income_range" id="income_range" value="0-4943" class="form-radio text-blue-500" required>
              <span class="ml-2">0 - 4943</span>
            </label>
            <label class="inline-flex items-center">
              <input type="radio" name="income_range" value="4944-9215" class="form-radio text-blue-500">
              <span class="ml-2">4944 - 9215</span>
            </label>
            <label class="inline-flex items-center">
              <input type="radio" name="income_range" value="9216-15239" class="form-radio text-blue-500">
              <span class="ml-2">9216 - 15239</span>
            </label>
            <label class="inline-flex items-center">
              <input type="radio" name="income_range" value="15240-21623" class="form-radio text-blue-500">
              <span class="ml-2">15240 - 21623</span>
            </label>
            <label class="inline-flex items-center">
              <input type="radio" name="income_range" value="Over 21624" class="form-radio text-blue-500">
              <span class="ml-2">Over 21624 </span>
            </label>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="text-center">
          <button type="submit"
            class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
            Calculate
          </button>
        </div>
      </form>
    </div>

    <div id="resultsPanel" hidden class="bg-white p-4 rounded shadow mb-6">
      <div id="explanation">
        <h2 class="text-2xl font-semibold mb-4">Your Results</h2>
        <p class="mb-4 text-lg">
          With your <span class="text-blue-500 font-semibold" id="resultsYearsInCanada"></span> years in Canada after
          age 18, you're eligible for a monthly OAS benefit of
          <span class="text-blue-500 font-semibold" id="resultsOasAt65"></span>, which is
          <span class="text-blue-500 font-semibold" id="resultsCanadaMultiplier"></span>
          of the full amount <span class="text-blue-500 font-semibold" id="resultsOasFullAmount"></span>,
          starting at age <span class="text-blue-500 font-semibold" id="resultsDefaultAge"></span>.
        </p>
        <p class="mb-4 text-lg">
          Delaying OAS to age <span class="text-blue-500 font-semibold" id="resultsDelayAge"></span> will increase
          your payment by <span class="text-blue-500 font-semibold" id="resultsPercentageIncrease"></span>
          to <span class="text-blue-500 font-semibold" id="resultsOasDelayed"></span>.
        </p>
        <p class="mb-4 text-lg">
          While delaying does result in a larger monthly payment, it also means forgoing <span
            class="text-blue-500 font-semibold" id="resultsYearsMissed"></span> years of payments
          from age <span class="text-blue-500 font-semibold" id="resultsDefaultAge"></span> to your delayed starting
          age of <span class="text-blue-500 font-semibold" id="resultsDelayAge"></span>.
        </p>

        <!-- This should only be shown if GIS eligible -->
        <div id="gisPanel" hidden>
          <p class="mb-4 text-lg">
            <span class="bg-yellow-200 inline-block px-2 py-1 rounded-lg">
              Furthermore, your selected income range makes you eligible for an approximate monthly GIS benefit of
              <span class="text-blue-500 font-bold" id="resultsGisAmount"></span>
              which you can only get by claiming OAS.
            </span>
          </p>
        </div>

        <p class="mb-4 text-lg">
          Those <span class="text-blue-500 font-semibold" id="resultsYearsMissed"></span> years of missed payments
          represent an income loss of <span class="text-blue-500 font-semibold" id="resultsOasDuringYearsMissed"></span>.
        </p>

        <p class="mb-4 text-lg">
          In order to break even (have the same amount of money) from delaying OAS to <span
            class="text-blue-500 font-semibold" id="resultsDelayAge"></span>, you would have to
          live until at least <span class="text-blue-500 font-semibold" id="resultsBreakevenAge"></span> years old. If
          you live beyond this, then you will end up with more OAS
          overall than if you had started at <span class="text-blue-500 font-semibold" id="resultsDefaultAge"></span>.
        </p>

        <p class="mb-4 text-lg">
          The chart below shows how much total OAS you will have accumulated at each age whether you started at
          <span class="text-blue-500 font-semibold" id="resultsDefaultAge"></span> or <span
            class="text-blue-500 font-semibold" id="resultsDelayAge"></span>.
          Where the two lines cross over is the break even point.
        </p>

        <canvas id="myChart"></canvas>
      </div>
    </div>

    <!-- About -->
    <div class="bg-white p-4 rounded shadow mb-6">
      <h2 class="text-2xl font-semibold mb-4">About This Project</h2>
      <p class="text-lg leading-relaxed mb-4">
        This project is a prototype developed by <span class="text-blue-500 font-semibold"><a
            href="https://linktr.ee/danielabaron/" target="_blank" rel="noopener noreferrer">Daniela Baron</a></span>, a Ruby on
        Rails engineer actively seeking new opportunities. It was created in collaboration with <span
          class="text-blue-500 font-semibold"><a href="https://openpolicyontario.com/" target="_blank"
            rel="noopener noreferrer">John Stapleton</a></span> of Open Policy Ontario.
            The goal is to improve uptake of OAS among seniors,
            particularly those in a low income bracket that could also be eligible for GIS (Guaranteed Income Supplement).
      </p>
      <p class="text-lg leading-relaxed mb-4">
        <span class="font-semibold text-gray-700">Found a bug? <a
            href="https://github.com/danielabar/oas-delay-calculator-prototype/issues" target="_blank"
            class="underline">Report issues here</a>.</span>
      </p>
    </div>

  </div>

  <script>
    // TODO: Organize all source data from a single json, fetch it, so there's only one file to change
    // Ref: https://www.canada.ca/en/services/benefits/publicpensions/cpp/old-age-security/benefit-amount.html
    // Ref: https://www150.statcan.gc.ca/n1/en/catalogue/84-537-X
    // Ref: https://www.canada.ca/en/services/benefits/publicpensions/cpp/old-age-security/guaranteed-income-supplement/eligibility.html
    // Ref: https://www.canada.ca/en/services/benefits/publicpensions/cpp/old-age-security/guaranteed-income-supplement/benefit-amount.html
    const lifeExpectancy = 83
    const fullOasAmount = 713.34
    const requiredYearsInCanadaAsAdult = 40
    const minAge = 65
    const delayMultiplierPerMonth = 0.006 // 0.6% increase per month
    const closeEnoughToBreakEven = 2000
    const gisIncomeFloor = 21624
    const gisAmount = 1065

    // we have to pick somewhere to end, and in the case of GIS, it could be very high
    const finalAge = 110

    // Maintenance issue - govt updates 4 x year, how are we going to keep up with data changes?
    // Ref: https://open.canada.ca/data/en/dataset/dfa4daf1-669e-4514-82cd-982f27707ed0 (Table 1, Single, Split into quartiles)
    const gisDataRows = [
      { annualIncomeFrom: 0, annualIncomeTo: 23.99, totalMonthlyGIS: 1065.47 },
      { annualIncomeFrom: 4928, annualIncomeTo: 4943.99, totalMonthlyGIS: 799.47 },
      { annualIncomeFrom: 4944, annualIncomeTo: 4967.99, totalMonthlyGIS: 798.47 },
      { annualIncomeFrom: 9200, annualIncomeTo: 9215.99, totalMonthlyGIS: 532.47 },
      { annualIncomeFrom: 9216, annualIncomeTo: 9239.99, totalMonthlyGIS: 531.47 },
      { annualIncomeFrom: 15216, annualIncomeTo: 15239.99, totalMonthlyGIS: 266.43 },
      { annualIncomeFrom: 15240, annualIncomeTo: 15263.99, totalMonthlyGIS: 265.43 },
      { annualIncomeFrom: 21600, annualIncomeTo: 21623.99, totalMonthlyGIS: 0.43 }
    ];

    // Keep a reference to the chart because we need to check if its already populated
    // when attempting to re-render
    let myChart = null

    // FIRST we calculate how many 40ths of the full amount user is eligible for based on years in Canada.
    // SECOND apply the months delay multiplier if applicable.
    function determineOasAmount(yearsInCanada, ageTakingOas) {
      yearsInCanadaFraction = yearsInCanada / requiredYearsInCanadaAsAdult
      interimAmount = fullOasAmount * yearsInCanadaFraction
      if (ageTakingOas == minAge) {
        return interimAmount
      } else {
        const delayedMonths = (ageTakingOas - minAge) * 12
        const multiplier = 1 + (delayedMonths * delayMultiplierPerMonth);
        return interimAmount * multiplier;
      }
    }

    const generateChartData = (yearsInCanada, gisAmount) => {
      const monthlyAmount = determineOasAmount(yearsInCanada, minAge) + gisAmount

      let dataPoints = [];
      dataPoints.push({ x: minAge, y: 0 })

      for (let age = minAge + 1; age <= finalAge; age++) {
        let totalBenefit = (age - minAge) * 12 * monthlyAmount;
        dataPoints.push({ x: age, y: totalBenefit });
      }

      return dataPoints;
    };

    const generateChartDataDelayed = (yearsInCanada, ageTakingOas, gisAmount) => {
      const monthlyAmount = determineOasAmount(yearsInCanada, ageTakingOas) + gisAmount

      let dataPoints = [];
      dataPoints.push({ x: ageTakingOas, y: 0 })

      for (let age = ageTakingOas + 1; age <= finalAge; age++) {
        let totalBenefit = (age - ageTakingOas) * 12 * monthlyAmount;
        dataPoints.push({ x: age, y: totalBenefit });
      }

      return dataPoints;
    };

    // Find the breakeven age (where the two lines intersect approximately)
    function findBreakevenAge(dataDefault, dataDelayed, ageTakingOas) {
      let breakevenAge = null;

      for (let age = ageTakingOas; age <= finalAge; age++) {
        const benefitAtDefaultAge = dataDefault.find(item => item.x === age)?.y || 0;
        const benefitAtDelayedAge = dataDelayed.find(item => item.x === age)?.y || 0;

        if (Math.abs(benefitAtDelayedAge - benefitAtDefaultAge) <= closeEnoughToBreakEven) {
          breakevenAge = age;
          break;
        }
      }
      if (breakevenAge === null) {
        console.error('Could not find breakeven age');
        return "Beyond Human Lifetime"
      }
      return breakevenAge;
    };

    function generateChart(dataDefault, dataDelayed, breakEvenAge, ageTakingOas) {
      const ctx = document.getElementById('myChart').getContext('2d');

      // If a chart instance already exists, destroy it
      if (myChart) {
        myChart.destroy();
      }

      const data = {
        datasets: [
          {
            label: `Starting at Age ${minAge}`,
            data: dataDefault,
            borderColor: 'rgb(75, 192, 192)',
            tension: 0.1,
            fill: false
          },
          {
            label: `Starting at Age ${ageTakingOas} (Delayed)`,
            data: dataDelayed,
            borderColor: 'rgb(255, 99, 132)',
            tension: 0.1,
            fill: false
          }
        ]
      };

      const options = {
        responsive: true,
        plugins: {
          tooltip: {
            callbacks: {
              label: function (tooltipItem) {
                return `Age ${tooltipItem.raw.x}: $${tooltipItem.raw.y.toLocaleString()}`;
              }
            }
          },
          annotation: {
            annotations: [
              {
                type: 'line',
                mode: 'vertical',
                scaleID: 'x',
                value: breakEvenAge,
                borderColor: 'gray',
                borderWidth: 2,
                label: {
                  content: `Breakeven Age: ${breakEvenAge}`,
                  enabled: true,
                  position: 'start'
                }
              }
            ]
          }
        },
        scales: {
          x: {
            type: 'linear',
            position: 'bottom',
            title: {
              display: true,
              text: 'Age'
            },
            ticks: {
              stepSize: 5
            }
          },
          y: {
            title: {
              display: true,
              text: 'Total Benefits Received'
            },
            ticks: {
              callback: function (value, index, values) {
                return '$' + value.toLocaleString(); // Add thousands separators
              }
            }
          }
        }
      };

      myChart = new Chart(ctx, {
        type: 'line',
        data: data,
        options: options
      });
    }

    // Add form submit handler to intercept regular form submission
    document.getElementById('oas-form').addEventListener('submit', calculate);

    // In absence of declarative templates for this prototype,
    // we have to imperatively update the DOM
    function updateContent(selector, value) {
      const elements = document.querySelectorAll(`#${selector}`)
      elements.forEach(element => {
        element.textContent = value
      });
    }
    function updateResults(results) {
      updateContent('resultsYearsInCanada', results.yearsInCanada);
      updateContent('resultsOasAt65', `${results.oasAt65.toFixed(2)}`);
      updateContent('resultsCanadaMultiplier', `${results.canadaMultiplier.toFixed(3)}`);
      updateContent('resultsOasFullAmount', `${fullOasAmount.toFixed(2)}`);
      updateContent('resultsDefaultAge', minAge);
      updateContent('resultsDelayAge', results.delayAge);
      updateContent('resultsPercentageIncrease', `${(results.percentageIncrease * 100).toFixed(1)}%`);
      updateContent('resultsOasDelayed', `${results.oasDelayed.toFixed(2)}`);
      updateContent('resultsYearsMissed', results.yearsMissed);
      updateContent('resultsBreakevenAge', results.breakEvenAge);
      updateContent('resultsOasDuringYearsMissed', results.oasDuringYearsMissed.toLocaleString('en-CA', { style: 'currency', currency: 'CAD' }));


      document.getElementById('resultsPanel').removeAttribute('hidden');

      if (results.gisAmount > 0) {
        document.getElementById('gisPanel').removeAttribute('hidden');
        updateContent('resultsGisAmount', `${results.gisAmount.toFixed(2)}`);
      } else {
        document.getElementById('gisPanel').setAttribute('hidden', true);
      }
    }

    // Naively simple
    function determineGisAmount(incomeRange) {
      if (incomeRange.startsWith('Over')) {
        return 0; // Not eligible for GIS
      }

      const [minIncome, maxIncome] = incomeRange.split('-').map(value => parseFloat(value.trim()));
      const minRow = gisDataRows.find(row => minIncome >= row.annualIncomeFrom && minIncome <= row.annualIncomeTo);
      const maxRow = gisDataRows.find(row => maxIncome >= row.annualIncomeFrom && maxIncome <= row.annualIncomeTo);

      if (minRow && maxRow) {
        const averageGIS = (minRow.totalMonthlyGIS + maxRow.totalMonthlyGIS) / 2
        return averageGIS
      } else {
        console.error(`Could not find rows for income range ${incomeRange}`)
        return 0
      }
    }

    // This runs when the form is submitted to perform all calculations and show results
    function calculate(evt) {
      evt.preventDefault();

      const yearsInCanada = Number(document.getElementById('years-in-canada').value);
      const ageTakingOas = Number(document.getElementById('age-taking-oas').value);
      const gisRangeElement = document.querySelector('input[name="income_range"]:checked');
      const gisRange = gisRangeElement ? gisRangeElement.value : null;

      const gisAmount = determineGisAmount(gisRange)
      const dataDefault = generateChartData(yearsInCanada, gisAmount);
      const dataDelayed = generateChartDataDelayed(yearsInCanada, ageTakingOas, gisAmount);
      const breakEvenAge = findBreakevenAge(dataDefault, dataDelayed, ageTakingOas)

      // Calculate the required values
      const oasAt65 = determineOasAmount(yearsInCanada, minAge)
      const oasDelayed = determineOasAmount(yearsInCanada, ageTakingOas)
      const percentageIncrease = (oasDelayed - oasAt65) / oasAt65;
      const yearsMissed = ageTakingOas - minAge;
      const oasDuringYearsMissed = yearsMissed * 12 * (oasAt65 + gisAmount)

      // Construct results object
      const results = {
        yearsInCanada,
        oasAt65,
        canadaMultiplier: yearsInCanada / requiredYearsInCanadaAsAdult,
        oasFullAmount: fullOasAmount,
        defaultAge: minAge,
        delayAge: ageTakingOas,
        percentageIncrease,
        oasDelayed,
        yearsMissed,
        breakEvenAge,
        gisAmount,
        oasDuringYearsMissed
      };

      // Update the UI with results
      updateResults(results);
      generateChart(dataDefault, dataDelayed, breakEvenAge, ageTakingOas)
    }
  </script>
</body>

</html>
